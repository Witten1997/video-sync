# 下载管理

## 下载流程

1. **扫描阶段**：根据任务源配置，获取视频列表
2. **过滤阶段**：应用过滤规则，筛选符合条件的视频
3. **队列阶段**：视频加入下载队列
4. **下载阶段**：yt-dlp 执行下载
5. **元数据生成**：创建NFO、下载封面、转换弹幕

## 下载控制

### 并发设置
```yaml
concurrent_limit:
  video: 3  # 同时下载3个视频
  page: 2   # 每个视频2个分P并发
```

### 质量选择
- `480P`：标清
- `720P`：高清
- `1080P`：全高清
- `1080P+`：最高画质（含HDR/高码率）

### 断点续传
下载中断后自动从断点继续。

## 任务监控

**实时状态**：
- 队列中任务数
- 下载中任务数
- 已完成/失败数

**详细信息**：
- 下载进度百分比
- 当前速度
- 预计剩余时间
- 错误日志

## 手动操作

### 视频列表
「视频管理」页面：
- 搜索视频
- 按状态过滤（已下载/未下载/失败）
- 手动触发下载
- 查看视频详情
- 在线播放

### 任务管理
「任务管理」页面：
- 暂停/恢复任务
- 取消任务
- 重试失败任务
- 查看日志

## 文件组织

### 目录结构
```
downloads/bilibili/
├── UP主名称1/
│   ├── 视频标题1/
│   │   ├── 视频标题1.mp4
│   │   ├── 视频标题1.nfo
│   │   ├── poster.jpg
│   │   └── 视频标题1.ass
│   └── 视频标题2/
└── UP主名称2/
```

### 元数据文件
- **NFO**：Kodi格式，包含标题、描述、发布日期、演员（UP主）等
- **Poster**：视频封面图
- **ASS字幕**：转换后的弹幕文件
- **UP主头像**：存储在 `metadata/people/`

## 故障处理

### 下载失败
常见原因：
- 网络问题：自动重试
- 视频被删除/下架：标记为失败
- 登录凭证过期：重新扫码登录

### 重试机制
失败任务可手动重试或等待下次同步自动重试。
