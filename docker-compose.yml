version: '3.8'

services:
  video-sync:
    build:
      context: .
      dockerfile: Dockerfile
    image: video-sync:latest
    container_name: video-sync
    restart: unless-stopped

    # 环境变量配置
    environment:
      # 时区设置
      - TZ=Asia/Shanghai

      # PostgreSQL 数据库配置
      - POSTGRES_USER=bili_sync
      - POSTGRES_PASSWORD=your_secure_password_here
      - POSTGRES_DB=bili_sync

      # 应用配置（可选）
      - APP_PORT=8080

    # 端口映射 - 只开放前端端口
    ports:
      - "8080:80"        # 前端服务端口（映射到本地8080）
      # PostgreSQL 端口不对外开放
      # 后端服务端口不对外开放

    # 数据卷挂载
    volumes:
      # PostgreSQL 数据持久化
      - postgres_data:/var/lib/postgresql/data

      # 下载文件存储
      - ./downloads:/downloads

      # 元数据存储
      - ./metadata:/metadata

      # 日志文件
      - ./logs:/var/log/bili-sync

      # 配置文件（可选，用于自定义配置）
      - ./configs:/app/configs

    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # 资源限制（可选，根据实际情况调整）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 4G
    #     reservations:
    #       cpus: '1'
    #       memory: 2G

# 数据卷定义
volumes:
  postgres_data:
    driver: local

# 网络配置（可选）
# networks:
#   default:
#     driver: bridge
